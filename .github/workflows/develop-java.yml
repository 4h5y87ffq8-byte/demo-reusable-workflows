name: ğŸš§ Java Develop Workflow

on:
  workflow_call:

jobs:
  build-tests:
    name: ğŸ—ï¸ Build & Tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Export YAML entries as env vars
        uses: 4h5y87ffq8-byte/demo-reusable-workflows/.github/action/export-yaml-env@main
        with:
          file: .a5x_devops
          root_prefix: .a5x_devops

      - name: ğŸ’¾ Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
          key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-${{ runner.os }}-

      - name: â˜• Set up JDK ${{ env.a5x_devops__build__stack_version }}
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ env.a5x_devops__build__stack_version }}

      - name: ğŸ—ï¸ Build with Maven
        working-directory: ${{ env.a5x_devops__build__working_directory }}
        run: mvn clean install

      - name: ğŸ§ª Run Unit Tests
        working-directory: ${{ env.a5x_devops__build__working_directory }}
        run: mvn test

  publish-deploy:
    name: ğŸ—ï¸ Publish & Deploy
    runs-on: ubuntu-latest
    needs: build-tests
    steps:
      - name: ğŸ” AWS Authentication ECR
        id: aws-auth-ecr
        uses: 4h5y87ffq8-byte/demo-reusable-workflows/.github/action/aws-auth-ecr@main
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.a5x_devops__deploy__dev__region }}

      - name: ğŸ“ Extract version from pom.xml
        id: version
        working-directory: ${{ env.a5x_devops__build__working_directory }}
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=${GITHUB_SHA:0:8}" >> $GITHUB_OUTPUT

      - name: ğŸ³ Build & Push Docker Image
        uses: 4h5y87ffq8-byte/demo-reusable-workflows/.github/action/docker-build-push@main
        with:
          working-directory: ${{ env.a5x_devops__build__working_directory }}
          image-name: ${{ env.a5x_devops__deploy__image_name }}
          repository: ${{ env.a5x_devops__deploy__repository }}
          registry: ${{ steps.aws-auth-ecr.outputs.registry }}
          tag: ${{ steps.version.outputs.version }}-${{ steps.version.outputs.short_sha }}

      - name: ğŸ“ Update task definition with new image
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: ${{ env.a5x_devops__deploy__dev__task_definition_file }}
          container-name: ${{ env.a5x_devops__deploy__ecs__container_name }}
          image: ${{ steps.aws-auth-ecr.outputs.registry }}/${{ env.a5x_devops__deploy__repository }}:${{ steps.version.outputs.version }}-${{ steps.version.outputs.short_sha }}

      - name: ğŸ¯ Deploy to ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.task-def.outputs.task-definition }}
          service: ${{ env.a5x_devops__deploy__ecs__service_name }}
          cluster: ${{ env.a5x_devops__deploy__ecs__cluster_name }}
          wait-for-service-stability: true
